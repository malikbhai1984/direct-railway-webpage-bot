let eventSource = null;

// Update Pakistan time
function updatePakistanTime() {
  const now = new Date();
  const pktTime = now.toLocaleString('en-PK', {
    timeZone: 'Asia/Karachi',
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: true
  });
  document.getElementById('pktTime').textContent = `üáµüá∞ ${pktTime}`;
}

// Get status badge
function getStatusBadge(status) {
  const statusMap = {
    'NS': { class: 'status-ns', text: 'Not Started' },
    'LIVE': { class: 'status-live', text: 'LIVE' },
    '1H': { class: 'status-live', text: '1st Half' },
    '2H': { class: 'status-live', text: '2nd Half' },
    'HT': { class: 'status-ht', text: 'Half Time' },
    'FT': { class: 'status-ft', text: 'Full Time' },
    'ET': { class: 'status-live', text: 'Extra Time' },
    'P': { class: 'status-live', text: 'Penalties' }
  };
  const s = statusMap[status] || { class: 'status-ns', text: status };
  return `<span class="status-badge ${s.class}">${s.text}</span>`;
}

// Render matches with Pakistan time
function renderMatches(matches) {
  const container = document.getElementById('matchesContainer');
  if (!matches || matches.length === 0) {
    container.innerHTML = '<div class="empty-state">üì≠ No matches scheduled for today</div>';
    document.getElementById('matchBadge').textContent = '0';
    return;
  }
  container.innerHTML = matches.map(match => `
    <div class="match-card">
      <div class="match-header">
        <span class="league-badge">${match.league_name || 'Unknown'}</span>
        ${getStatusBadge(match.status)}
      </div>
      <div class="match-time">
        üïê <span class="time-pkt">${match.match_time_pkt || 'Time TBA'}</span>
      </div>
      <div class="teams">
        <div class="team">${match.home_team}</div>
        <div class="vs">VS</div>
        <div class="team">${match.away_team}</div>
      </div>
      ${match.status !== 'NS' ? `
      <div class="score">
        <span>${match.home_score || 0}</span>
        <span>-</span>
        <span>${match.away_score || 0}</span>
      </div>
      ` : ''}
      ${match.venue ? `<div style="text-align:center; color:#666; font-size:0.8rem; margin-top:5px;">üìç ${match.venue}</div>` : ''}
    </div>
  `).join('');
  document.getElementById('matchCount').textContent = matches.length;
  document.getElementById('matchBadge').textContent = matches.length;
}

// Render predictions (with all advanced fields)
function renderPredictions(predictions) {
  const container = document.getElementById('predictionsContainer');
  if (!predictions || predictions.length === 0) {
    container.innerHTML = '<div class="empty-state">ü§ñ Predictions loading...</div>';
    document.getElementById('predBadge').textContent = '0';
    return;
  }
  container.innerHTML = predictions.map(pred => `
    <div class="prediction-card">
      <div class="match-header">
        <span class="league-badge">${pred.league || 'Unknown'}</span>
        <span class="confidence-badge">‚≠ê ${pred.confidence_score || 0}% Confidence</span>
      </div>
      <div class="teams">
        <div class="team">${pred.home_team}</div>
        <div class="vs">VS</div>
        <div class="team">${pred.away_team}</div>
      </div>
      <div class="match-time">
        üïê <span class="time-pkt">${pred.match_time_pkt || 'Time TBA'}</span>
      </div>
      <!-- Winner Probabilities -->
      <div class="prob-bars">
        <div class="prob-bar">
          <div class="prob-label">Home Win</div>
          <div class="prob-value home">${pred.winner_prob?.home || 0}%</div>
        </div>
        <div class="prob-bar">
          <div class="prob-label">Draw</div>
          <div class="prob-value draw">${pred.winner_prob?.draw || 0}%</div>
        </div>
        <div class="prob-bar">
          <div class="prob-label">Away Win</div>
          <div class="prob-value away">${pred.winner_prob?.away || 0}%</div>
        </div>
      </div>
      <!-- xG Display -->
      <div class="xg-display">
        <div class="xg-item">
          <div class="xg-label">Home xG</div>
          <div class="xg-value">${pred.xG?.home || 0}</div>
        </div>
        <div class="xg-item">
          <div class="xg-label">Total xG</div>
          <div class="xg-value">${pred.xG?.total || 0}</div>
        </div>
        <div class="xg-item">
          <div class="xg-label">Away xG</div>
          <div class="xg-value">${pred.xG?.away || 0}</div>
        </div>
      </div>
      <!-- Markets -->
      <div class="markets">
        <div class="market-item">
          <div class="market-label">BTTS</div>
          <div class="market-value">${pred.btts_prob || 0}%</div>
        </div>
        <div class="market-item">
          <div class="market-label">Over 2.5</div>
          <div class="market-value">${pred.over_under?.['2.5'] || 0}%</div>
        </div>
        <div class="market-item">
          <div class="market-label">Over 3.5</div>
          <div class="market-value">${pred.over_under?.['3.5'] || 0}%</div>
        </div>
        <div class="market-item">
          <div class="market-label">Last 10 min</div>
          <div class="market-value">${pred.last10_prob || 0}%</div>
        </div>
      </div>
      <!-- Strong Markets -->
      ${pred.strong_markets && pred.strong_markets.length > 0 ? `
      <div class="strong-markets">
        <h4>üî• High Confidence (‚â•85%)</h4>
        ${pred.strong_markets.map(m => `
          <div class="strong-market-item">
            <span>${m.market}</span>
            <span><strong>${m.prob}%</strong></span>
            ${pred.odds_suggestion && pred.odds_suggestion[m.market] ? `<span style="margin-left:8px;color:#19547b;font-size:0.8em;">Odds: ${pred.odds_suggestion[m.market]}</span>` : ""}
          </div>
        `).join('')}
      </div>
      ` : ''}
      <!-- Correct Scores -->
      ${pred.correct_scores && pred.correct_scores.length > 0 ? `
      <div class="markets" style="margin-top:10px;">
        <div class="market-item" style="background:#e8eaf0;">
          <div class="market-label">Top Correct Scores</div>
          <div class="market-value">
            ${pred.correct_scores.map(cs => `${cs.score} (${cs.prob}%)`).join('<br>')}
          </div>
        </div>
      </div>
      ` : ''}
      <!-- Top Goal Minutes -->
      ${pred.top_goal_minutes && pred.top_goal_minutes.length > 0 ? `
      <div class="markets" style="margin-top:10px;">
        <div class="market-item" style="background:#e8eaf0;">
          <div class="market-label">Top Goal Minutes</div>
          <div class="market-value">
            ${pred.top_goal_minutes.map(min => `${min}'`).join(', ')}
          </div>
        </div>
      </div>
      ` : ''}
      <!-- Risk Note -->
      ${pred.risk_note ? `
      <div style="margin-top:10px; color:#ff4444; font-weight:bold; font-size:0.95em;">
        ‚ö†Ô∏è ${pred.risk_note}
      </div>
      ` : ''}
      <!-- Last 15 Match Stats -->
      ${pred.last15_stats ? `
      <div style="margin-top:10px; background:#f5f7fa; border-radius:8px; padding:8px;">
        <div style="font-size:0.9em; color:#764ba2; font-weight:bold;">Last 15 Match Stats</div>
        <div style="font-size:0.85em; margin-top:4px;">
          <b>${pred.home_team}:</b> GF: ${pred.last15_stats.home.GF}, GA: ${pred.last15_stats.home.GA}, W: ${pred.last15_stats.home.W}, D: ${pred.last15_stats.home.D}, L: ${pred.last15_stats.home.L}<br>
          <b>${pred.away_team}:</b> GF: ${pred.last15_stats.away.GF}, GA: ${pred.last15_stats.away.GA}, W: ${pred.last15_stats.away.W}, D: ${pred.last15_stats.away.D}, L: ${pred.last15_stats.away.L}
        </div>
      </div>
      ` : ''}
    </div>
  `).join('');
  document.getElementById('predCount').textContent = predictions.length;
  document.getElementById('predBadge').textContent = predictions.length;
}

// Update last update time
function updateLastUpdateTime() {
  const now = new Date();
  document.getElementById('lastUpdate').textContent = now.toLocaleTimeString('en-GB', {
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });
}

// Connect to SSE
function connectSSE() {
  if (eventSource) eventSource.close();
  eventSource = new EventSource('/events');
  eventSource.onmessage = (event) => {
    try {
      const data = JSON.parse(event.data);
      if (data.matches) renderMatches(data.matches);
      if (data.predictions) renderPredictions(data.predictions);
      updateLastUpdateTime();
      if (data.isNew) {
        // Show a notification or badge for new prediction
        showNewPredictionNotification(data.timestamp);
      }
    } catch (error) {
      console.error('‚ùå SSE Error:', error);
    }
  };
  eventSource.onerror = () => {
    console.log('‚ùå SSE disconnected. Reconnecting in 5s...');
    setTimeout(connectSSE, 5000);
  };
}

// Show new prediction notification
function showNewPredictionNotification(pktTime) {
  // You can use a toast, modal, or badge. Here is a simple alert:
  const notif = document.createElement('div');
  notif.textContent = `üü¢ New Prediction Available! (Pakistan Time: ${pktTime})`;
  notif.style.position = 'fixed';
  notif.style.top = '20px';
  notif.style.right = '20px';
  notif.style.background = '#56ab2f';
  notif.style.color = 'white';
  notif.style.padding = '12px 20px';
  notif.style.borderRadius = '8px';
  notif.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
  notif.style.zIndex = 9999;
  notif.style.fontWeight = 'bold';
  document.body.appendChild(notif);
  setTimeout(() => notif.remove(), 4000);
}

// Initial data fetch (fallback)
async function fetchInitialData() {
  try {
    const [matchesRes, predictionsRes] = await Promise.all([
      fetch('/api/matches'),
      fetch('/api/predictions')
    ]);
    const matchesData = await matchesRes.json();
    const predictionsData = await predictionsRes.json();
    if (matchesData.success) renderMatches(matchesData.data);
    if (predictionsData.success) renderPredictions(predictionsData.data);
    updateLastUpdateTime();
  } catch (error) {
    console.error('‚ùå Initial fetch error:', error);
  }
}

// Initialize
window.addEventListener('DOMContentLoaded', () => {
  updatePakistanTime();
  setInterval(updatePakistanTime, 1000);
  fetchInitialData();
  connectSSE();
  setInterval(updateLastUpdateTime, 1000);
});

// Cleanup
window.addEventListener('beforeunload', () => {
  if (eventSource) eventSource.close();
});
