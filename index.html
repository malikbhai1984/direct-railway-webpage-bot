<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Live Football Predictions (PKT)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{ background:#0b0b0b; color:#fff; font-family:Arial, sans-serif; margin:0; padding:18px; }
  header{ text-align:center; margin-bottom:12px }
  .layout{ display:flex; gap:18px; align-items:flex-start; max-width:1200px; margin:0 auto; }
  .left{ width:38%; background:#111; padding:12px; border-radius:10px; border:1px solid #222; }
  .right{ width:62%; background:#0e0f10; padding:12px; border-radius:10px; border:2px solid #00ff90; }
  h2{ margin:6px 0 12px 0; color:#00ff90 }
  .match{ padding:8px; border-bottom:1px solid #222; }
  .predCard{ padding:10px; margin-bottom:10px; border-radius:8px; background:#151515; }
  /* Strong style for 85%+ Confidence Markets */
  .strong{ background:#073; color:#fff; } 
  .small{ font-size:12px; color:#bbb }
  .meta{ font-size:13px; color:#9cc; margin-bottom:8px }
  @media(max-width:900px){ .layout{ flex-direction:column } .left,.right{ width:100% } }
</style>
</head>
<body>
<header>
  <h1>âš½ Live Auto Predictions (PKT)</h1>
  <div class="small">Auto updates every 5â€“7 minutes. No reload required.</div>
</header>

<div class="layout">
  <div class="left">
    <h2>ðŸ“… Today Matches (PKT)</h2>
    <div id="matchList">Loading...</div>
  </div>

  <div class="right">
    <h2>ðŸ”® Live Predictions (85%+ Confidence)</h2>
    <div id="predList">Waiting for updates...</div>
  </div>
</div>

<script>
  // --- Left Side: Load Today Matches ---
  async function loadToday(){
    try{
      const r = await fetch('/today');
      const j = await r.json();
      const box = document.getElementById('matchList');
      if(!j.success){ box.innerHTML = 'Error: '+(j.error||''); return; }
      if(j.data.length===0){ box.innerHTML = '<div class="small">No top league matches for today.</div>'; return; }
      let html='';
      j.data.forEach(m=>{
        html += `<div class="match"><strong>${m.home} vs ${m.away}</strong><div class="small">${m.league} â€¢ ${m.kickoff} PKT â€¢ ${m.status}</div></div>`;
      });
      box.innerHTML = html;
    }catch(e){ document.getElementById('matchList').innerHTML = 'Fetch error: Check Server.js console'; }
  }
  loadToday();

  // Optionally refresh matches list every 7 minutes
  setInterval(loadToday, 7*60*1000); 

  // --- Right Side: SSE for Live Predictions (Auto Update) ---
  const predBox = document.getElementById('predList');
  const sse = new EventSource('/events'); // Connect to server.js SSE endpoint

  sse.onopen = ()=> { predBox.innerHTML = '<div class="small">Connected â€” Waiting for first prediction snapshot...</div>'; };
  sse.onerror = ()=> { predBox.innerHTML = '<div class="small" style="color:#f33">Connection lost. Check backend.</div>'; };

  sse.onmessage = (e) => {
    try{
      const data = JSON.parse(e.data);
      if(!data || !data.matches){ predBox.innerHTML = 'No data'; return; }
      
      let html = `<div class="meta">Updated (PKT): ${data.ts}</div>`;
      
      data.matches.forEach(item=>{
        const p = item.prediction;
        
        // Check if ANY strong market (85%+) exists to apply the 'strong' class
        const isStrong = (p && p.strongMarkets && p.strongMarkets.length > 0);
        
        html += `<div class="predCard ${isStrong? 'strong':''}">`;
        html += `<div><strong>${item.teams}</strong> <span class="small">(${item.matchDate})</span></div>`;
        
        if(p){
          // Display main probabilities
          html += `<div>Winner: Home ${p.winnerProb.home}% â€¢ Draw ${p.winnerProb.draw}% â€¢ Away ${p.winnerProb.away}%</div>`;
          html += `<div>BTTS: ${p.bttsProb}%</div>`;
          
          // Display Strong Markets (85%+ Confidence Bets)
          if(p.strongMarkets && p.strongMarkets.length){
             html += `<div>âœ… **CONFIRM BETS (85%+):** ${p.strongMarkets.map(s=>`<span style="color:#ffcc00;">${s.market} (${s.prob}%)</span>`).join(' | ')}</div>`;
          } else {
             html += `<div class="small">No 85%+ Strong Market found yet.</div>`;
          }

          // Display Expected Goals and Late Goal Info
          html += `<div class="small">ExpGoals: Total ${p.expectedGoals.total} â€¢ Late Goal Prob: ${p.last10Prob}%</div>`;
        } else {
          html += `<div class="small">No prediction data yet.</div>`;
        }
        html += `</div>`;
      });
      predBox.innerHTML = html;
    }catch(err){
      predBox.innerHTML = '<div class="small" style="color:#f33">Front-end parse error.</div>';
      console.error("SSE parse error:",err);
    }
  };
</script>
</body>
</html>
